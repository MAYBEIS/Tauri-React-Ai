name: IPC测试

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test-frontend:
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v3
    
    - name: 设置Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'yarn'
    
    - name: 安装依赖
      run: yarn install --frozen-lockfile
    
    - name: 运行前端测试
      run: yarn test:ci
    
    - name: 生成测试覆盖率报告
      run: yarn test:coverage
    
    - name: 上传测试覆盖率到Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage/lcov.info
        flags: frontend
        name: frontend-coverage

  test-rust:
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v3
    
    - name: 设置Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        override: true
    
    - name: 安装Tauri依赖
      run: |
        sudo apt-get update
        sudo apt-get install -y libwebkit2gtk-4.0-dev \
          libgtk-3-dev \
          libayatana-appindicator3-dev \
          librsvg2-dev
    
    - name: 缓存Cargo依赖
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
    
    - name: 运行Rust测试
      run: yarn test:rust
      working-directory: ./src-tauri
    
    - name: 生成Rust测试覆盖率
      run: |
        cargo install cargo-tarpaulin
        cargo tarpaulin --out Xml
      working-directory: ./src-tauri
    
    - name: 上传Rust测试覆盖率到Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./src-tauri/cobertura.xml
        flags: rust
        name: rust-coverage

  test-integration:
    runs-on: ubuntu-latest
    needs: [test-frontend, test-rust]
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v3
    
    - name: 设置Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'yarn'
    
    - name: 设置Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        override: true
    
    - name: 安装Tauri依赖
      run: |
        sudo apt-get update
        sudo apt-get install -y libwebkit2gtk-4.0-dev \
          libgtk-3-dev \
          libayatana-appindicator3-dev \
          librsvg2-dev
    
    - name: 安装依赖
      run: yarn install --frozen-lockfile
    
    - name: 运行集成测试
      run: yarn test:all
    
    - name: 构建应用（验证集成）
      run: yarn tauri build

  test-performance:
    runs-on: ubuntu-latest
    needs: [test-integration]
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v3
    
    - name: 设置Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'yarn'
    
    - name: 安装依赖
      run: yarn install --frozen-lockfile
    
    - name: 运行性能测试
      run: |
        yarn test
        yarn test:coverage
      env:
        NODE_ENV: production

  security-scan:
    runs-on: ubuntu-latest
    needs: [test-integration]
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v3
    
    - name: 设置Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'yarn'
    
    - name: 安装依赖
      run: yarn install --frozen-lockfile
    
    - name: 运行npm audit
      run: yarn audit --audit-level moderate
    
    - name: 设置Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        override: true
    
    - name: 安装cargo-audit
      run: cargo install cargo-audit
    
    - name: 运行cargo audit
      run: cargo audit
      working-directory: ./src-tauri